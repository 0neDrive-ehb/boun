<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bouncing Ball</title>
  <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
  <script src="https://cdn.webrtc-experiment.com/whammy.js"></script>
  <style>
    body {
      margin: 0;
      overflow: hidden;
    }

    #square {
      position: relative;
      width: 300px; /* Adjusted width for a vertical phone video */
      height: 533px; /* Adjusted height for a vertical phone video */
      border: 8px solid #000; /* thicker border */
      margin: 50px auto;
      transition: background-color 0.3s ease, border-color 0.3s ease; /* color change transition */
    }

    #square.bounce {
      /* set these properties using JavaScript */
    }

    .ball {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: hsl(0, 100%, 50%);
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3), 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    .trail {
      position: absolute;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      opacity: 0.5;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.3), 0 5px 10px rgba(0, 0, 0, 0.2);
    }

    #recordButton {
      position: fixed;
      bottom: 20px;
      right: 20px;
      padding: 10px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="square">
    <div class="ball" id="ball"></div>
  </div>

  <button id="recordButton">Record</button>

  <script>
    function random(min, max) {
      return Math.floor(Math.random() * (max - min + 1)) + min;
    }

    const square = document.getElementById('square');
    const ball = document.getElementById('ball');
    const recordButton = document.getElementById('recordButton');
    const trailContainer = createTrailContainer();
    let x = Math.random() * (square.offsetWidth - ball.offsetWidth);
    let y = Math.random() * (square.offsetHeight - ball.offsetHeight);
    let speed = 2;
    let angle = Math.random() * Math.PI * 2;
    let hue = 0;
    let trailLength = 10;
    let frameCounter = 0;
    let recording = false;
    let recorder;

    function createTrailContainer() {
      const trailContainer = document.createElement('div');
      trailContainer.className = 'trail-container';
      square.appendChild(trailContainer);
      return trailContainer;
    }

    function updatePosition() {
      x += speed * Math.cos(angle);
      y += speed * Math.sin(angle);

      // Bounce off the square borders
      if (x + ball.offsetWidth >= square.offsetWidth || x <= 0) {
        angle = Math.PI - angle; // Bounce horizontally
        playBounceSound();
        updateColors();
        speed *= 1.02; // Increase speed by 5%
      }

      if (y + ball.offsetHeight >= square.offsetHeight || y <= 0) {
        angle = -angle; // Bounce vertically
        playBounceSound();
        updateColors();
        speed *= 1.05; // Increase speed by 5%
      }

      ball.style.transform = `translate(${x}px, ${y}px)`;
      ball.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;

      frameCounter++;
      if (frameCounter % 3 === 0) {
        updateTrail();
      }
    }

    function playBounceSound() {
      const audio = new Audio();
      audio.src = `piano-mp3_${String.fromCharCode(65 + random(0, 5))}1.mp3`;
      audio.currentTime = 0;
      audio.play();
      square.classList.add('bounce');
      setTimeout(() => {
        square.classList.remove('bounce');
      }, 300);
    }

    function updateColors() {
      const newHue = random(0, 360);
      square.style.backgroundColor = `hsl(${newHue}, 100%, 50%)`;
      square.style.borderColor = `hsl(${newHue}, 100%, 50%)`;
      hue = (hue + 30) % 360;
    }

    function updateTrail() {
      const trail = document.createElement('div');
      trail.className = 'trail';
      trail.style.transform = `translate(${x}px, ${y}px)`;
      trail.style.backgroundColor = `hsl(${hue}, 100%, 50%)`;
      trailContainer.appendChild(trail);

      if (trailContainer.children.length > trailLength) {
        trailContainer.removeChild(trailContainer.children[0]);
      }
    }

    function animate() {
      updatePosition();
      if (recording) {
        recorder.addFrame(square, { copy: true, delay: 42 });
      }
      requestAnimationFrame(animate);
    }

    function startRecording() {
      recorder = RecordRTC(square, {
        type: 'canvas',
        showMousePointer: true,
        useWhammyRecorder: true,
      });
      recorder.startRecording();
    }

    function stopRecording() {
      recorder.stopRecording(() => {
        const blob = recorder.getBlob();
        invokeSaveAsDialog(blob);
      });
    }

    recordButton.addEventListener('click', () => {
      if (!recording) {
        startRecording();
        recordButton.textContent = 'Stop Recording';
      } else {
        stopRecording();
        recordButton.textContent = 'Record';
      }
      recording = !recording;
    });

    animate();
  </script>
</body>
</html>
